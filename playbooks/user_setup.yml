- hosts: all
  remote_user: root
  tasks:
    - name: Install ARCH sudo
      block:
      - name: install packets for sudo
        pacman:
          name:
            - sudo
          state: present
    
      - name: set sshd_config for VPS
        template:
          src: ../templates/sshd_config_arch
          dest: /etc/ssh/sshd_config

      when: ansible_facts['distribution'] == 'Archlinux'

    - name: Install Debian sudo
      block:
      - name: install Debian packets for sudo
        apt:
          name:
            - sudo
          state: present

      - name: set sshd_config for VPS
        template:
          src: ../templates/sshd_config_deb
          dest: /etc/ssh/sshd_config

      when: ansible_facts['distribution'] == 'Ubuntu'

    - name: Make sure we have a 'wheel' group
      group:
        name: wheel
        state: present  

    - name: Allow 'wheel' group to have passwordless sudo
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%wheel'
        line: '%wheel ALL=(ALL) NOPASSWD: ALL'
        validate: visudo -cf %s  

    - name: add ansible user to VPN hosts
      user: 
        name: ansible
        state: present
        append: yes
        create_home: yes
        groups: wheel
        generate_ssh_key: yes
        ssh_key_type: ecdsa
        ssh_key_bits: 521
    
    # - name: allow wheel users use sudo
    #   template:
    #     src: ../templates/sudoers
    #     dest: /etc/sudoers
    #     validate: visudo -cf %s

    - name: copy ssh autorized public keys 
      become_user: ansible
      become: yes
      template:
        src: /home/demmy/.ssh/id_rsa.pub
        dest: /home/ansible/.ssh/authorized_keys
        backup: yes
        mode: 0600

    - name: restart ssh daemon
      service:
        name: sshd
        enabled: yes
        state: restarted
